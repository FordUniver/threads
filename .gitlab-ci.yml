# GitLab CI/CD for threads CLI - Multi-language testing
# Tests all 7 implementations on every push

stages:
  - test
  - benchmark

variables:
  GIT_DEPTH: 1

# Template for test jobs
.test_template:
  stage: test
  before_script:
    - echo "Testing $CI_JOB_NAME implementation"
  artifacts:
    when: on_failure
    paths:
      - test/results/
    expire_in: 1 week

# Go implementation
test:go:
  extends: .test_template
  image: golang:1.24
  before_script:
    - apt-get update && apt-get install -y gawk make jq wget
    - wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 && chmod +x /usr/local/bin/yq
  script:
    - make test-go

# Python implementation
test:python:
  extends: .test_template
  image: python:3.12
  before_script:
    - apt-get update && apt-get install -y gawk make jq wget
    - wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 && chmod +x /usr/local/bin/yq
    - pip install uv
  script:
    - make test-python

# Perl implementation
test:perl:
  extends: .test_template
  image: perl:5.38
  before_script:
    - apt-get update && apt-get install -y gawk make jq wget
    - wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 && chmod +x /usr/local/bin/yq
    - cpanm --notest YAML::Tiny
  script:
    - make test-perl

# Rust implementation
test:rust:
  extends: .test_template
  image: rust:1.82
  before_script:
    - apt-get update && apt-get install -y gawk make jq wget
    - wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 && chmod +x /usr/local/bin/yq
  script:
    - make test-rust

# Swift implementation
test:swift:
  extends: .test_template
  image: swift:5.9
  before_script:
    - apt-get update && apt-get install -y gawk make jq wget
    - wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 && chmod +x /usr/local/bin/yq
  script:
    - make test-swift

# Ruby implementation
test:ruby:
  extends: .test_template
  image: ruby:3.3
  before_script:
    - apt-get update && apt-get install -y gawk make jq wget
    - wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 && chmod +x /usr/local/bin/yq
  script:
    - make test-ruby

# Bun implementation
test:bun:
  extends: .test_template
  image: oven/bun:1.0
  before_script:
    - apt-get update && apt-get install -y gawk make jq git wget
    - wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 && chmod +x /usr/local/bin/yq
  script:
    - make test-bun

# Benchmark job - compares implementations on same hardware
# Runs scripting languages (easy to set up) + Go (fast to build)
benchmark:
  stage: benchmark
  image: golang:1.24
  needs:
    - job: test:go
      optional: true
    - job: test:python
      optional: true
    - job: test:perl
      optional: true
    - job: test:ruby
      optional: true
    - job: test:bun
      optional: true
  before_script:
    - apt-get update && apt-get install -y python3 perl ruby curl unzip bc
    # Install uv (for Python) via official installer
    - curl -LsSf https://astral.sh/uv/install.sh | sh && export PATH="$HOME/.local/bin:$PATH"
    # Install bun
    - curl -fsSL https://bun.sh/install | BUN_INSTALL=/usr/local bash
    # Install Perl YAML::Tiny
    - cpan -T YAML::Tiny 2>/dev/null || true
  script:
    - export PATH="$HOME/.local/bin:$PATH"
    - cd test/benchmark
    - chmod +x *.sh
    # Generate workspace with 1000 threads
    - ./generate-workspace.sh 1000
    # Run benchmark with 5 iterations
    - ./bench.sh 5 1000
    - echo "=== Benchmark Results ==="
    - cat benchmark-results.csv
  artifacts:
    paths:
      - test/benchmark/benchmark-results.csv
    expire_in: 1 month
  rules:
    # Run on main branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    # Run on merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Allow manual trigger on any branch
    - when: manual
      allow_failure: true
