# GitLab CI/CD for threads CLI - Multi-language testing
# Tests all 8 implementations on every push

stages:
  - test

variables:
  GIT_DEPTH: 1

# Template for test jobs
.test_template:
  stage: test
  before_script:
    - echo "Testing $CI_JOB_NAME implementation"
  artifacts:
    when: on_failure
    paths:
      - test/results/
    expire_in: 1 week

# Shell implementation (Bash)
test:shell:
  extends: .test_template
  image: bash:5.2
  before_script:
    - apk add --no-cache coreutils grep gawk git make perl perl-yaml-tiny
  script:
    - make test-shell

# Go implementation
test:go:
  extends: .test_template
  image: golang:1.22
  before_script:
    - apt-get update && apt-get install -y gawk make
  script:
    - make test-go

# Python implementation
test:python:
  extends: .test_template
  image: python:3.12
  before_script:
    - apt-get update && apt-get install -y gawk make
    - pip install uv
  script:
    - make test-python

# Perl implementation
test:perl:
  extends: .test_template
  image: perl:5.38
  before_script:
    - apt-get update && apt-get install -y gawk make
    - cpanm --notest YAML::Tiny
  script:
    - make test-perl

# Rust implementation
test:rust:
  extends: .test_template
  image: rust:1.75
  before_script:
    - apt-get update && apt-get install -y gawk make
  script:
    - make test-rust

# Swift implementation
test:swift:
  extends: .test_template
  image: swift:5.9
  before_script:
    - apt-get update && apt-get install -y gawk make
  script:
    - make test-swift

# Ruby implementation
test:ruby:
  extends: .test_template
  image: ruby:3.3
  before_script:
    - apt-get update && apt-get install -y gawk make
  script:
    - make test-ruby

# Bun implementation
test:bun:
  extends: .test_template
  image: oven/bun:1.0
  before_script:
    - apt-get update && apt-get install -y gawk make
  script:
    - make test-bun

# Optional: Run all tests in a single job (useful for quick verification)
test:all:
  extends: .test_template
  image: debian:bookworm
  only:
    - main
    - merge_requests
  before_script:
    - apt-get update
    - apt-get install -y bash coreutils grep gawk git curl build-essential
    # Install Go
    - curl -L https://go.dev/dl/go1.22.0.linux-amd64.tar.gz | tar -C /usr/local -xz
    - export PATH=$PATH:/usr/local/go/bin
    # Install Rust
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - export PATH=$HOME/.cargo/bin:$PATH
    # Install Swift
    - apt-get install -y binutils libc6-dev libcurl4-openssl-dev libedit2 libgcc-9-dev libpython3.9 libsqlite3-0 libstdc++-9-dev libxml2-dev libz3-dev pkg-config tzdata zlib1g-dev
    - curl -L https://download.swift.org/swift-5.9.2-release/ubuntu2204/swift-5.9.2-RELEASE/swift-5.9.2-RELEASE-ubuntu22.04.tar.gz | tar -C / -xz --strip-components=1
    # Install Python + uv
    - apt-get install -y python3 python3-pip
    - pip3 install --break-system-packages uv
    # Install Perl
    - apt-get install -y perl
    # Install Ruby
    - apt-get install -y ruby
    # Install Bun
    - curl -fsSL https://bun.sh/install | bash
    - export PATH=$HOME/.bun/bin:$PATH
  script:
    - make test-all
  allow_failure: true  # This job is expensive; don't block pipeline if it fails
