# GitLab CI/CD for threads CLI (Rust)

stages:
  - test
  - release

variables:
  GIT_DEPTH: 1
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo

# Cache cargo dependencies
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cargo/registry
    - target/

# Unit tests
test:
  stage: test
  image: rust:latest
  script:
    - cargo test --verbose

# Integration tests
integration-test:
  stage: test
  image: rust:latest
  before_script:
    - apt-get update && apt-get install -y gawk make jq
    - cargo build
  script:
    - ./test/run_tests.sh ./target/debug/threads
  artifacts:
    when: on_failure
    paths:
      - test/results/
    expire_in: 1 week

# Dev release - push to Package Registry on main
dev-release:
  stage: release
  image: rust:latest
  before_script:
    - apt-get update && apt-get install -y curl musl-tools
    - rustup target add x86_64-unknown-linux-musl
  script:
    - cargo build --release --target x86_64-unknown-linux-musl
    - |
      curl --header "JOB-TOKEN: $CI_JOB_TOKEN" \
           --upload-file target/x86_64-unknown-linux-musl/release/threads \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/threads/dev/threads-linux-amd64"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Tagged release - create GitLab Release
# Note: Cross-platform builds done locally, binaries uploaded manually
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    description: "Release $CI_COMMIT_TAG"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+/
