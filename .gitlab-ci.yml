# GitLab CI/CD for threads CLI

stages:
  - test
  - benchmark

variables:
  GIT_DEPTH: 1

# Unit tests - Go tests
unit-test:
  stage: test
  image: golang:1.24
  script:
    - cd go && go test -v ./...
  artifacts:
    when: on_failure
    paths:
      - go/
    expire_in: 1 week

# Integration tests - CLI behavior tests
integration-test:
  stage: test
  image: golang:1.24
  before_script:
    - apt-get update && apt-get install -y gawk make jq wget
    - wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 && chmod +x /usr/local/bin/yq
  script:
    - make integration-test
  artifacts:
    when: on_failure
    paths:
      - test/results/
    expire_in: 1 week

# Benchmark - performance tracking
benchmark:
  stage: benchmark
  image: golang:1.24
  needs:
    - job: integration-test
      optional: true
  before_script:
    - apt-get update && apt-get install -y gawk make jq wget bc
    - wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 && chmod +x /usr/local/bin/yq
  script:
    - make build
    - cd test/benchmark
    - chmod +x *.sh
    # Generate workspace with 3000 threads
    - ./generate-workspace.sh 3000
    # Run benchmark with 5 iterations
    - ./bench.sh 5 3000
    - echo "=== Benchmark Results ==="
    - cat benchmark-results.csv
  artifacts:
    paths:
      - test/benchmark/benchmark-results.csv
    expire_in: 1 month
  rules:
    # Run on main branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    # Run on merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Allow manual trigger on any branch
    - when: manual
      allow_failure: true
