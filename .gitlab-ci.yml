# GitLab CI/CD for threads CLI (Rust)

stages:
  - test
  - release

variables:
  GIT_DEPTH: 1
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo

# Cache cargo dependencies
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cargo/registry
    - target/

# Unit tests
test:
  stage: test
  image: rust:latest
  script:
    - cargo test --verbose

# Integration tests
integration-test:
  stage: test
  image: rust:latest
  before_script:
    - apt-get update && apt-get install -y gawk make jq
    - cargo build
  script:
    - ./test/run_tests.sh ./target/debug/threads
  artifacts:
    when: on_failure
    paths:
      - test/results/
    expire_in: 1 week

# Tagged release - create GitLab Release
# Note: Cross-platform builds done locally, binaries uploaded manually
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    description: "Release $CI_COMMIT_TAG"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+/
